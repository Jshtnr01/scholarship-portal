<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Navigation Bar -->
  <nav class="bg-green-700 text-white p-4 flex justify-between items-center shadow-md">
    <h1 class="font-bold text-lg">Admin Dashboard</h1>
    <ul class="flex space-x-6">
      <li>
        <a href="scholarship.html" class="hover:text-green-200 transition">Scholarship</a>
      </li>
      <li>
        <button id="logout-btn" class="hover:text-green-200 transition">Log Out</button>
      </li>
    </ul>
  </nav>

  <!-- Page Content -->
  <div class="p-6">
    <h1 class="text-2xl font-bold mb-4">Admin Dashboard</h1>

    <div class="grid grid-cols-4 gap-4 mb-6">
      <div id="totalAppsCard" class="p-4 bg-white shadow rounded">Total Applications: <span id="totalApps">0</span></div>
      <div id="pendingAppsCard" class="p-4 bg-white shadow rounded">Pending: <span id="pendingApps">0</span></div>
      <div id="approvedAppsCard" class="p-4 bg-white shadow rounded">Approved: <span id="approvedApps">0</span></div>
      <div id="deniedAppsCard" class="p-4 bg-white shadow rounded">Denied: <span id="deniedApps">0</span></div>
    </div>

    <h2 class="text-xl font-semibold mb-2">Applications</h2>
    <table class="w-full bg-white shadow rounded mb-6">
      <thead class="bg-green-200">
        <tr>
          <th class="p-2">Name</th>
          <th class="p-2">Scholarship</th>
          <th class="p-2">Date</th>
          <th class="p-2">File</th>
          <th class="p-2">Status</th>
          <th class="p-2">Action</th>
        </tr>
      </thead>
      <tbody id="appTable"></tbody>
    </table>

    <h2 class="text-xl font-semibold mb-2">Scholars</h2>
    <table class="w-full bg-white shadow rounded">
      <thead class="bg-green-200">
        <tr>
          <th class="p-2">Name</th>
          <th class="p-2">Scholarship</th>
          <th class="p-2">Start Date</th>
          <th class="p-2">Status</th>
        </tr>
      </thead>
      <tbody id="scholarTable"></tbody>
    </table>
  </div>

  <!-- Script -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Supabase setup
    const SUPABASE_URL = "https://evhccomzwzcwtlzjkcig.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGNjb216d3pjd3RsemprY2lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDg2NjcsImV4cCI6MjA3MjIyNDY2N30.GL3cvUlJs7woFRXBgc0x3JAH93ZysfbN7jmbamcnb8c";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Logout button handler
    document.getElementById("logout-btn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "index.html"; // redirect after logout
    });

    async function loadApplications() {
      const { data: apps, error } = await supabase.from("Applicants").select("*");

      if (error) {
        console.error("Error fetching apps:", error.message);
        return;
      }

      // Stats
      document.getElementById("totalApps").textContent = apps.length;
      document.getElementById("pendingApps").textContent = apps.filter(a => a.status === "pending").length;
      document.getElementById("approvedApps").textContent = apps.filter(a => a.status === "approved").length;
      document.getElementById("deniedApps").textContent = apps.filter(a => a.status === "denied").length;

      // Table
      const appTable = document.getElementById("appTable");
      appTable.innerHTML = "";

      apps.forEach(app => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-2 border">${app.fullname}</td>
          <td class="p-2 border">${app.scholarship_name}</td>
          <td class="p-2 border">${new Date(app.created_at).toLocaleDateString()}</td>
          <td class="p-2 border">
            ${app.document_url ? `<a href="${app.document_url}" target="_blank" class="text-blue-600 underline">View</a>` : "N/A"}
          </td>
          <td class="p-2 border">${app.status}</td>
          <td class="p-2 border">
            <button class="bg-green-500 text-white px-2 py-1 rounded approveBtn" data-id="${app.id}">Approve</button>
            <button class="bg-red-500 text-white px-2 py-1 rounded denyBtn" data-id="${app.id}">Deny</button>
          </td>
        `;
        appTable.appendChild(row);
      });

      attachActionHandlers();
    }

    function attachActionHandlers() {
      document.querySelectorAll(".approveBtn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.dataset.id;
          await updateStatus(id, "approved");
        });
      });

      document.querySelectorAll(".denyBtn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.dataset.id;
          await updateStatus(id, "denied");
        });
      });
    }

    async function updateStatus(id, status) {
      const { error } = await supabase.from("Applicants").update({ status }).eq("id", id);
      if (error) {
        console.error("Error updating status:", error.message);
        return;
      }
      loadApplications(); // refresh
    }

    // Load apps on page load
    loadApplications();
  </script>
</body>
</html>
